---
- name: Crear usuarios con contrase침a default y acceso sudo
  hosts: all
  become: true

  vars_files:
    - ../vars/users.yml
    - ../vars/default_password.yml

  tasks:
    - name: Verificar si los usuarios ya existen
      getent:
        database: passwd
        key: "{{ item.name }}"
      register: user_check
      loop: "{{ users }}"
      failed_when: false

    - name: Mostrar usuarios existentes
      debug:
        msg: "El usuario {{ item.item.name }} ya existe en el sistema"
      loop: "{{ user_check.results }}"
      when: item.ansible_facts is defined

    - name: Crear usuarios con home, shell y contrase침a
      user:
        name: "{{ item.name }}"
        comment: "{{ item.full_name }}"
        password: "{{ default_password }}"
        shell: /bin/bash
        state: present
        create_home: yes
        groups: "{{ 'wheel' if ansible_os_family == 'RedHat' else 'sudo' }}"
        append: yes
      loop: "{{ users }}"
      when: user_check.results | selectattr('item.name', 'equalto', item.name) | selectattr('ansible_facts', 'undefined') | list | length > 0

    - name: Forzar cambio de contrase침a al iniciar sesi칩n (solo usuarios nuevos)
      command: chage -d 0 {{ item.name }}
      loop: "{{ users }}"
      when: user_check.results | selectattr('item.name', 'equalto', item.name) | selectattr('ansible_facts', 'undefined') | list | length > 0